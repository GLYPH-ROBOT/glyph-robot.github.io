<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Size Estimator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .isometric-cube {
            transform-style: preserve-3d;
            transform: rotateX(45deg) rotateZ(45deg);
        }
        
        .leaflet-container {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
            background: #242424;
        }
        
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }

        #map {
            z-index: 0;
        }

        /* Dark mode map styles */
        .leaflet-tile {
            filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(0.9);
        }
    </style>
</head>
<body class="min-h-screen p-4 bg-gray-900 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        const EstimateTool = () => {
            const [size, setSize] = React.useState({ width: 5, height: 5, depth: 5 });
            const [isDragging, setIsDragging] = React.useState(false);
            const [dragStart, setDragStart] = React.useState({ x: 0, y: 0 });
            const [location, setLocation] = React.useState({ lat: 37.7749, lng: -122.4194 });
            const [price, setPrice] = React.useState(0);
            const [map, setMap] = React.useState(null);
            const [marker, setMarker] = React.useState(null);

            // Initialize map
            React.useEffect(() => {
                if (map) map.remove();

                const mapInstance = L.map('map').setView([39.8283, -98.5795], 4);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(mapInstance);

                // SF marker
                L.circleMarker([37.7749, -122.4194], {
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 1,
                    radius: 8
                }).addTo(mapInstance)
                    .bindPopup('San Francisco');

                // Location marker
                const locationMarker = L.marker([location.lat, location.lng], {
                    draggable: true
                }).addTo(mapInstance);

                locationMarker.on('dragend', (e) => {
                    const pos = e.target.getLatLng();
                    setLocation({ lat: pos.lat, lng: pos.lng });
                });

                mapInstance.on('click', (e) => {
                    locationMarker.setLatLng(e.latlng);
                    setLocation({ lat: e.latlng.lat, lng: e.latlng.lng });
                });

                setMap(mapInstance);
                setMarker(locationMarker);
            }, []);

            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            };

            const calculatePrice = () => {
                const volume = size.width * size.height * size.depth;
                const distance = calculateDistance(37.7749, -122.4194, location.lat, location.lng);
                const basePrice = volume * 10;
                const distanceFactor = Math.max(1, Math.log(distance + 1));
                return basePrice * distanceFactor;
            };

            const handleMouseDown = (e) => {
                setIsDragging(true);
                setDragStart({
                    x: e.clientX || e.touches?.[0].clientX,
                    y: e.clientY || e.touches?.[0].clientY
                });
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                
                const currentX = e.clientX || e.touches?.[0].clientX;
                const currentY = e.clientY || e.touches?.[0].clientY;
                const deltaX = currentX - dragStart.x;
                const deltaY = currentY - dragStart.y;

                setSize(prev => ({
                    width: Math.max(1, prev.width + deltaX * 0.05),
                    height: Math.max(1, prev.height - deltaY * 0.05),
                    depth: Math.max(1, prev.depth + (deltaX - deltaY) * 0.025)
                }));

                setDragStart({ x: currentX, y: currentY });
            };

            const handleMouseUp = () => {
                setIsDragging(false);
            };

            React.useEffect(() => {
                setPrice(calculatePrice());
            }, [size, location]);

            React.useEffect(() => {
                if (marker) {
                    marker.setLatLng([location.lat, location.lng]);
                }
            }, [location, marker]);

            const cubeStyle = {
                width: `${size.width * 10}px`,
                height: `${size.height * 10}px`,
                transform: `rotateX(45deg) rotateZ(45deg)`,
                transformStyle: 'preserve-3d',
                position: 'relative',
                cursor: isDragging ? 'grabbing' : 'grab'
            };

            return (
                <div className="max-w-md mx-auto bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div className="p-6">
                        <h1 className="text-2xl font-bold text-center mb-6 text-white">
                            Choose Your Building Size
                        </h1>
                        
                        <div className="flex flex-col items-center space-y-6">
                            <div 
                                className="relative w-64 h-64 flex items-center justify-center touch-none"
                                onMouseDown={handleMouseDown}
                                onMouseMove={handleMouseMove}
                                onMouseUp={handleMouseUp}
                                onMouseLeave={handleMouseUp}
                                onTouchStart={handleMouseDown}
                                onTouchMove={handleMouseMove}
                                onTouchEnd={handleMouseUp}
                            >
                                <div 
                                    className="bg-blue-400/20 border-2 border-blue-400" 
                                    style={cubeStyle}
                                >
                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-blue-400">
                                        ↔
                                    </div>
                                </div>
                            </div>

                            <div className="text-center space-y-2 text-gray-100">
                                <p>Width: {size.width.toFixed(1)}m</p>
                                <p>Height: {size.height.toFixed(1)}m</p>
                                <p>Depth: {size.depth.toFixed(1)}m</p>
                            </div>

                            <div className="w-full space-y-2">
                                <label className="block text-sm font-medium text-gray-100">
                                    Location:
                                </label>
                                <div id="map" className="w-full h-64 rounded-lg"></div>
                            </div>

                            <div className="text-center">
                                <p className="text-3xl font-bold text-white">
                                    ${price.toLocaleString(undefined, {maximumFractionDigits: 2})}
                                </p>
                                <p className="text-sm text-gray-400">
                                    Distance from SF: {calculateDistance(37.7749, -122.4194, location.lat, location.lng).toFixed(0)} km
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EstimateTool />);
    </script>
</body>
</html>
